<!doctype html><meta charset="utf-8">
<title>GRAY CORD — Chronological Timeline</title>
<style>
body{font:14px/1.6 system-ui;margin:20px}
h1{margin:0 0 12px}
h2{margin-top:28px;border-left:4px solid #999;padding-left:8px}
.badge{font-size:12px;padding:2px 6px;border-radius:6px;margin-left:6px}
.published{background:#e6ffe6;border:1px solid #8bc48b}
.draft{background:#fff5e6;border:1px solid #e2a55e}
.planned{background:#eef;border:1px solid #99a}
.note{background:#eee;border:1px solid #bbb}
ul{margin:6px 0 16px 20px}
li{margin:4px 0}
small{color:#666}
.error{background:#fee;border:1px solid #e66;padding:8px;border-radius:8px;margin:8px 0}
</style>
<h1>Chronological Timeline (for Author)</h1>
<div id="msg"></div>
<div id="root"></div>
<script type="module">
async function safeJson(url){
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    return await res.json();
  }catch(e){
    const m = document.getElementById('msg');
    const div = document.createElement('div');
    div.className='error';
    div.textContent = `⚠️ Failed to load ${url}: ${e.message}`;
    m.append(div);
    return null;
  }
}
const base = new URL('.', import.meta.url);
// Try local folder first (same directory), then ../data fallback
const toc = await (async ()=>{
  return (await safeJson(new URL('./toc.json', base))) 
      || (await safeJson(new URL('../data/toc.json', base))) 
      || [];
})();
const timeline = await (async ()=>{
  return (await safeJson(new URL('./timeline.json', base))) 
      || (await safeJson(new URL('../data/timeline.json', base))) 
      || [];
})();

const tocMap = new Map((toc||[]).map(x=>[String(x.id), x]));
const root = document.getElementById('root');

if(!timeline || !Array.isArray(timeline) || timeline.length===0){
  const p=document.createElement('p');p.className='error';
  p.textContent='No timeline data found. Place timeline.json next to this HTML or under ../data/.';
  root.append(p);
}else{
  for (const y of timeline.sort((a,b)=>a.year-b.year)) {
    const h = document.createElement('h2'); h.id = 'y'+y.year; h.textContent = y.year; root.append(h);
    const ul = document.createElement('ul');
    for (const ev of (y.items||[]).sort((a,b)=>(a.date||a.date_start||'').localeCompare(b.date||b.date_start||''))) {
      const li = document.createElement('li');
      const title = document.createElement('span');
      const badge = document.createElement('span');
      badge.className = `badge ${ev.status||'note'}`; badge.textContent = (ev.status||'note');
      // link resolution
      let linked = false;
      if (ev.refs && ev.refs.length) {
        for (const id of ev.refs) {
          const t = tocMap.get(String(id));
          if (t && t.status==='published' && t.url) {
            const a = document.createElement('a');
            a.href = t.url; a.target = '_blank';
            a.textContent = (ev.title_jp || ev.title_en || '(untitled)');
            title.append(a); linked = true; break;
          }
        }
      }
      if (!linked) title.textContent = (ev.title_jp || ev.title_en || '(untitled)');
      li.append(title, badge);
      if (ev.location || ev.actors) {
        const meta = document.createElement('small');
        meta.textContent = ` — ${ev.location||''}${ev.actors?(' / '+ev.actors.join(', ')) : ''}`;
        li.append(' ', meta);
      }
      ul.append(li);
    }
    root.append(ul);
  }
}
</script>
