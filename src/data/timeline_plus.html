<!doctype html><meta charset="utf-8">
<title>GRAY CORD — Chronological Timeline (Author Tools)</title>
<style>
:root{
  --fg:#1f2937; --muted:#6b7280; --line:#d1d5db; --accent:#2563eb;
  --bg:#ffffff; --badge:#111827;
}
*{box-sizing:border-box}
body{font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif; margin:20px; color:var(--fg); background:var(--bg)}
header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:0 0 12px}
h1{margin:0 12px 0 0;font-size:20px}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.controls input[type="text"]{padding:6px 8px;border:1px solid var(--line);border-radius:8px;min-width:220px}
.chk{display:inline-flex;gap:6px;align-items:center;padding:2px 6px;border:1px solid var(--line);border-radius:999px;background:#f8fafc}
.btn{padding:6px 10px;border:1px solid var(--line);border-radius:8px;background:#f9fafb;cursor:pointer}
.btn:hover{background:#eef2ff;border-color:#c7d2fe}
.badge{font-size:12px;padding:2px 6px;border-radius:6px;margin-left:6px;color:#111}
.published{background:#e6ffe6;border:1px solid #8bc48b}
.draft{background:#fff5e6;border:1px solid #e2a55e}
.planned{background:#eef;border:1px solid #99a}
.note{background:#eee;border:1px solid #bbb}
.year{margin-top:22px;border-left:4px solid #999;padding-left:8px;display:flex;align-items:center;gap:8px}
.year a{color:var(--muted);text-decoration:none;font-size:12px}
ul{margin:6px 0 16px 24px;padding-left:12px;border-left:1px dashed #e5e7eb}
li{margin:4px 0}
small{color:var(--muted)}
.hidden{display:none !important}
.error{background:#fee;border:1px solid #e66;padding:8px;border-radius:8px;margin:8px 0}
.legend{margin:6px 0 12px;color:var(--muted);font-size:12px}
.fold{cursor:pointer;font-size:12px;color:var(--accent);border:none;background:transparent}
hr{border:0;border-top:1px solid #eee;margin:8px 0 12px}
</style>
<header>
  <h1>Chronological Timeline (for Author)</h1>
  <div class="controls">
    <input id="q" type="text" placeholder="Search title / location / actors…">
    <label class="chk"><input type="checkbox" class="f-status" value="published" checked>published</label>
    <label class="chk"><input type="checkbox" class="f-status" value="draft" checked>draft</label>
    <label class="chk"><input type="checkbox" class="f-status" value="planned" checked>planned</label>
    <label class="chk"><input type="checkbox" class="f-status" value="note" checked>note</label>
    <label class="chk"><input type="checkbox" id="linksOnly">links only</label>
    <button class="btn" id="expand">expand all</button>
    <button class="btn" id="collapse">collapse all</button>
  </div>
</header>
<div class="legend">Tip: click a year’s “fold” to toggle items. Use the URL hash like <code>#y1996</code> to jump.</div>
<div id="msg"></div>
<div id="root"></div>
<script type="module">
async function safeJson(url){
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    return await res.json();
  }catch(e){
    const m = document.getElementById('msg');
    const div = document.createElement('div');
    div.className='error';
    div.textContent = `⚠️ Failed to load ${url}: ${e.message}`;
    m.append(div);
    return null;
  }
}
const base = new URL('.', import.meta.url);
const toc = (await safeJson(new URL('./toc.json', base))) 
         || (await safeJson(new URL('../data/toc.json', base))) || [];
const timeline = (await safeJson(new URL('./timeline.json', base))) 
              || (await safeJson(new URL('../data/timeline.json', base))) || [];

const tocMap = new Map((toc||[]).map(x=>[String(x.id), x]));

const root = document.getElementById('root');
const q = document.getElementById('q');
const linkToggle = document.getElementById('linksOnly');
const chkStatuses = Array.from(document.querySelectorAll('.f-status'));
const expandBtn = document.getElementById('expand');
const collapseBtn = document.getElementById('collapse');

function build(){
  root.innerHTML = '';
  const statusAllow = new Set(chkStatuses.filter(c=>c.checked).map(c=>c.value));
  const needle = (q.value||'').toLowerCase().trim();
  const linksOnly = linkToggle.checked;

  for (const y of [...timeline].sort((a,b)=>a.year-b.year)) {
    const section = document.createElement('section');
    const h = document.createElement('div'); h.className='year'; h.id='y'+y.year;
    const H = document.createElement('h2'); H.textContent = y.year; H.style.margin='0';
    const fold = document.createElement('button'); fold.className='fold'; fold.textContent='fold';
    const anchor = document.createElement('a'); anchor.href = '#y'+y.year; anchor.textContent='#';
    h.append(H, fold, anchor); section.append(h);

    const ul = document.createElement('ul');
    let count=0;

    const items = [...(y.items||[])].sort((a,b)=>(a.date||a.date_start||'').localeCompare(b.date||b.date_start||''));
    for (const ev of items) {
      const status = ev.status || 'note';
      if(!statusAllow.has(status)) continue;

      const hay = [(ev.title_jp||''),(ev.title_en||''),(ev.location||''),(ev.actors||[]).join(' ')].join(' ').toLowerCase();
      if(needle && !hay.includes(needle)) continue;

      // does this event have at least one published link?
      let linkInfo = null;
      if (ev.refs && ev.refs.length){
        for(const id of ev.refs){
          const t = tocMap.get(String(id));
          if(t && t.status==='published' && t.url){ linkInfo = t; break; }
        }
      }
      if(linksOnly && !linkInfo) continue;

      const li = document.createElement('li');
      const title = document.createElement('span');
      const badge = document.createElement('span');
      badge.className = `badge ${status}`; badge.textContent = status;

      if(linkInfo){
        const a = document.createElement('a');
        a.href = linkInfo.url; a.target = '_blank';
        a.textContent = (ev.title_jp || ev.title_en || '(untitled)');
        title.append(a);
      }else{
        title.textContent = (ev.title_jp || ev.title_en || '(untitled)');
      }
      li.append(title, badge);

      if (ev.location || ev.actors) {
        const meta = document.createElement('small');
        meta.textContent = ` — ${ev.location||''}${ev.actors?(' / '+ev.actors.join(', ')) : ''}`;
        li.append(' ', meta);
      }
      ul.append(li); count++;
    }

    // start folded if no items
    if(count===0){ ul.classList.add('hidden'); fold.textContent='fold'; }
    fold.addEventListener('click', ()=>{
      ul.classList.toggle('hidden');
      fold.textContent = ul.classList.contains('hidden') ? 'expand' : 'fold';
    });

    section.append(ul);
    root.append(section);
  }
}

[q, linkToggle, ...chkStatuses].forEach(el => el.addEventListener('input', build));
expandBtn.addEventListener('click', ()=>{
  root.querySelectorAll('ul').forEach(u=>u.classList.remove('hidden'));
  root.querySelectorAll('.fold').forEach(b=>b.textContent='fold');
});
collapseBtn.addEventListener('click', ()=>{
  root.querySelectorAll('ul').forEach(u=>u.classList.add('hidden'));
  root.querySelectorAll('.fold').forEach(b=>b.textContent='expand');
});

build();

// Jump to hash on load
if(location.hash){
  const target = document.querySelector(location.hash);
  if(target) target.scrollIntoView({behavior:'smooth',block:'start'});
}
</script>
