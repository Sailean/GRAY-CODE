<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è¨˜äº‹ãƒšãƒ¼ã‚¸</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="css/sailean_uikit.css">
  <link rel="stylesheet" href="css/uikit.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.15.0/dist/css/uikit.min.css">
  <link href="fontawesome/css/fontawesome.css" rel="stylesheet" media="print" onload="this.media='all'">
</head>

<body>

  <!--  navigation  -->
  <nav class="uk-navbar-container">
    <div class="uk-container">
      <div uk-navbar>
        <div class="uk-navbar-left">
          <a class="uk-navbar-item uk-logo" href="index.html">Nonlinear Emotion Curves</a>
          <ul class="uk-navbar-nav uk-visible@m">
            <li>
              <a href="index.html">éç·šå½¢æ„Ÿæƒ…æ›²ç·š <span uk-navbar-parent-icon></span></a>
              <div class="uk-navbar-dropdown">
                <ul id="digest-nav"></ul>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

<div class="uk-section uk-section-default uk-section-small uk-padding">
  <div class="uk-container uk-container-expand">
    <!-- ä¸Šéƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="chapter-nav uk-margin">
      <a id="prev-link" href="#">â† å‰ã¸</a>
    </nav>
    <h3 id="article-title" class="heading">èª­ã¿è¾¼ã¿ä¸­â€¦</h3>
    <h4 id="article-meta"  class="heading"></h4>
    <div id="article-content" class="uk-card uk-card-default uk-card-body">  
    </div>
    <!-- ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼šæ¬¡ã¸ã ã‘ -->
    <nav class="chapter-nav uk-margin-large-top uk-text-center">
      <a id="next-link" href="#">æ¬¡ã¸ â†’</a>
    </nav>           
  </div>
</div>

<!-- ä¸Šã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
<div id="topbutton" onclick="scrollToTop()" class="arrow" title="ä¸Šã¸æˆ»ã‚‹">â†‘</div>

<!-- ãƒ¡ã‚¤ãƒ³è¨˜äº‹èª­ã¿è¾¼ã¿ -->
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const lang = urlParams.get('lang') || 'jp';
  const file = urlParams.get('file');

// ğŸ”¹ ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒŠãƒ“ç”¨ï¼ˆä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
// â¶ ä½¿ã† JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨€èªã”ã¨ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
const navSource = lang === 'en'
  ? 'en_articles.json'
  : 'articles.json';

fetch(navSource)
  .then(res => res.json())
  .then(data => {
    const navList = document.getElementById('digest-nav');

    // â· ã€Œç›®æ¬¡ã«æˆ»ã‚‹ã€ãƒªãƒ³ã‚¯ã‚‚è¨€èªã”ã¨ã«
    navList.innerHTML = `
      <li>
        <a href="index.html">
          ${lang === 'en' ? 'Table of Contents' : 'ç›®æ¬¡ï¼ˆIndexï¼‰'} 
        </a>
      </li>
    `;

    // â¸ å„ç« ãƒªãƒ³ã‚¯ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨€èªã”ã¨ã«å¤‰ãˆã‚‹
    navList.innerHTML += data.map(entry => {
      const title = lang === 'en'
        ? entry.title_en
        : entry.title_jp;

      const linkText = lang === 'en'
        ? `Chapter ${entry.chapter}: ${title}`
        : `ç¬¬${entry.chapter}ç«  ${title}`;

      return `
        <li>
          <a href="article.html?file=${entry.filename}&lang=${lang}">
            ${linkText}
          </a>
        </li>`;
    }).join('');
  })
  .catch(err => console.error(err));

  if (!file) {
    document.getElementById('article-content').innerHTML = '<p>âš  è¨˜äº‹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
  } else {
    fetch(lang === 'en' ? 'en_articles.json' : 'articles.json')
      .then(response => response.json())
      .then(fileMap => {
        const meta = fileMap.find(e => e.filename === file);
        const base = lang === 'en' ? 'en_articles' : 'articles';

        // ãƒ«ãƒ“è¾æ›¸ï¼ˆå¿…è¦ãªäººåã©ã‚“ã©ã‚“è¿½åŠ ã—ã¦OKï¼ï¼‰
        const rubyMap = {
          'æœ—': 'ã‚ãã‚‰',
          'çœ': 'ã¾ã“ã¨',
          'è‹±ç¾å­': 'ãˆã¿ã“'
        };

        // ãƒ«ãƒ“é©ç”¨é–¢æ•°
        function applyRuby(str) {
          return str.replace(/æœ—|çœ|è‹±ç¾å­/g, match => {
            const rt = rubyMap[match];
            return `<ruby>${match}<rt>${rt}</rt></ruby>`;
          });
        }

        // ç« ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºï¼ˆç¾…é¦¬æ•°å­—ã¾ãŸã¯ Chapterï¼‰
        const roman = ['', 'â… ', 'â…¡', 'â…¢', 'â…£', 'â…¤', 'â…¥', 'â…¦', 'â…§', 'â…¨', 'â…©'];
        const chap = meta.chapter;

        if (lang === 'en') {
          document.getElementById('article-title').innerText =
            `Chapter ${chap}: ${meta.title_en}`;
        } else {
          const rawTitle = `${roman[chap]}. ${meta.title_jp}`;
          const rubyTitle = applyRuby(rawTitle); // â† ã“ã“ã§ãƒ«ãƒ“é©ç”¨ï¼
          document.getElementById('article-title').innerHTML = rubyTitle; //         innerHTMLã«å¤‰æ›´ï¼
        }


        // â· ãƒ¡ã‚¿æƒ…å ±ï¼ˆæ—¥ä»˜ï¼‹å ´æ‰€ï¼‹ãƒ«ãƒ“å‡¦ç†ï¼‰
        let metaHtml = '';

        if (lang === 'en') {
          if (meta.timestamp) {
            const dt = new Date(meta.timestamp);
            const opts = {
              year:   'numeric',
              month:  'long',
              day:    'numeric',
              hour:   'numeric',
              minute: '2-digit',
              hour12: true
            };
            const la = new Intl.DateTimeFormat('en-US', {
              ...opts,
              timeZone: 'America/Los_Angeles'
            }).format(dt);
            const jp = new Intl.DateTimeFormat('en-US', {
              ...opts,
              timeZone: 'Asia/Tokyo'
            }).format(dt);
            metaHtml = `${la} â€” LA / ${jp} JST`;
          } else {
            metaHtml = `${meta.date} â€” ${meta.location_en}`;
          }
        } else {
          if (meta.timestamp) {
            const dt = new Date(meta.timestamp);
            const opts = {
              year:   'numeric',
              month:  'numeric',
              day:    'numeric',
              hour:   'numeric',
              minute: '2-digit',
              hour12: true
            };
            const la = new Intl.DateTimeFormat('ja-JP', {
              ...opts,
              timeZone: 'America/Los_Angeles'
            }).format(dt);
            const jp = new Intl.DateTimeFormat('ja-JP', {
              ...opts,
              timeZone: 'Asia/Tokyo'
            }).format(dt);

            const rubyLocation = applyRuby(meta.location_jp);
            metaHtml = `${la} ${rubyLocation} / ${jp} æ—¥æœ¬æ™‚é–“`;
          } else {
            const [Y, M, D] = meta.date.split('-');
            const rubyLocation = applyRuby(meta.location_jp);
            metaHtml = `${Y}å¹´${+M}æœˆ${+D}æ—¥ãƒ»${rubyLocation}`;
          }
        }
        document.getElementById('article-meta').innerHTML = metaHtml;

        // â¸ æœ¬æ–‡ã®èª­ã¿è¾¼ã¿
        fetch(`${base}/${file}`)
          .then(r => r.text())
          .then(text => {
            document.getElementById('article-content').innerHTML = marked.parse(text);
          });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // å‰å¾ŒãƒŠãƒ“ã®è¨­å®š
        const idx = fileMap.findIndex(e => e.filename === file);

        // ã€Œå‰ã¸ã€
        if (idx > 0) {
          const prev = fileMap[idx - 1];
          const a = document.getElementById('prev-link');
          a.href = `article.html?file=${prev.filename}&lang=${lang}`;
          a.innerText = lang === 'en'
            ? `â—€ Chapter ${prev.chapter}: ${prev.title_en}`
            : `â—€ ç¬¬${prev.chapter}ç«  ${prev.title_jp}`;
        } else {
          document.getElementById('prev-link').style.visibility = 'hidden';
        }

        // ã€Œæ¬¡ã¸ã€
        if (idx < fileMap.length - 1) {
          const next = fileMap[idx + 1];
          const a = document.getElementById('next-link');
          a.href = `article.html?file=${next.filename}&lang=${lang}`;
          a.innerText = lang === 'en'
            ? `Chapter ${next.chapter}: ${next.title_en} â–¶`
            : `ç¬¬${next.chapter}ç«  ${next.title_jp} â–¶`;
        } else {
          document.getElementById('next-link').style.visibility = 'hidden';
        }
      })
      .catch(error => {
        document.getElementById('article-content').innerHTML = '<p>âš  ãƒ¡ã‚¿æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
        console.error('JSON èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      });

      // ãƒšãƒ¼ã‚¸å…ˆé ­ã¸ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      document.addEventListener('DOMContentLoaded', () => {
  const topBtn = document.getElementById('topbutton');

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã‚‰è¡¨ç¤ºãƒ»éš ã™
  window.addEventListener('scroll', () => {
    if (window.scrollY > 200) {
      topBtn.style.display = 'block';
    } else {
      topBtn.style.display = 'none';
    }
  });
});
  }
</script>



<!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šæ¼”å‡ºç³» -->
<script>
  function runAkiraLogEffects() {
    const anchor = document.getElementById('cursor-anchor');
    if (anchor) {
      const cursor = document.createElement('span');
      cursor.id = 'terminal-cursor';
      anchor.parentNode.insertBefore(cursor, anchor.nextSibling);
    }

    const userSpans = document.querySelectorAll('.timestamp span.user');
    userSpans.forEach(span => {
      const text = span.innerText;
      if (text.includes('AKIRA:')) span.classList.add('akira-text');
      else if (text.includes('MAKO:')) span.classList.add('mako-text');
    });

    const messages = document.querySelectorAll('.timestamp');
    messages.forEach((msg, index) => {
      msg.style.opacity = '0';
      setTimeout(() => {
        msg.style.transition = 'opacity 0.1s ease-in';
        msg.style.opacity = '1';
      }, index * 50);
    });
  }
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«1å›ã ã‘å®Ÿè¡Œ
  document.addEventListener('DOMContentLoaded', runAkiraLogEffects);
</script>


<!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆé¡ -->
<script src="js/load_articles.js"></script>
<script src="js/scripts.js"></script>
<script src="js/uikit.js"></script>
<script src="js/uikit-icons.min.js"></script>
<script src="https://kit.fontawesome.com/e499977db9.js" crossorigin="anonymous"></script>

</body>
</html>