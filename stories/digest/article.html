<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¨˜äº‹ãƒšãƒ¼ã‚¸</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="../css/sailean_uikit.css">
  <link rel="stylesheet" href="../css/uikit.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.15.0/dist/css/uikit.min.css">
  <link href="fontawesome/css/fontawesome.css" rel="stylesheet" media="print" onload="this.media='all'">
</head>

<body>

  <!--  navigation  -->
  <nav class="uk-navbar-container">
    <div class="uk-container">
      <div uk-navbar>
        <div class="uk-navbar-left">
          <a class="uk-navbar-item uk-logo" href="index.html">Nonlinear Emotion Curves</a>
          <ul class="uk-navbar-nav uk-visible@m">
            <li>
              <a href="index.html">éç·šå½¢æ„Ÿæƒ…æ›²ç·š <span uk-navbar-parent-icon></span></a>
              <div class="uk-navbar-dropdown">
                <ul id="digest-nav"></ul>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="uk-section uk-section-default uk-section-small uk-padding">
    <div class="uk-container uk-container-expand">
      <!-- ä¸Šéƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <nav class="chapter-nav uk-margin">
        <a id="prev-link" href="#">â† å‰ã¸</a>
      </nav>
      <h3 id="article-title" class="heading">èª­ã¿è¾¼ã¿ä¸­â€¦</h3>
      <h4 id="article-meta" class="heading"></h4>
      <div id="article-content" class="uk-card uk-card-default uk-card-body">
      </div>
      <!-- ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼šæ¬¡ã¸ã ã‘ -->
      <nav class="chapter-nav uk-margin-large-top uk-text-center">
        <a id="next-link" href="#">æ¬¡ã¸ â†’</a>
      </nav>
    </div>
  </div>

  <!-- ä¸Šã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <div id="topbutton" onclick="initScrollTopButton()" class="arrow" title="ä¸Šã¸æˆ»ã‚‹">â†‘</div>

<!-- ãƒ¡ã‚¤ãƒ³è¨˜äº‹èª­ã¿è¾¼ã¿ï¼ˆå®Œå…¨ç‰ˆï¼‰ -->
<script type="module">
  /* ---------------- åŸºæœ¬æƒ…å ± ---------------- */
  const params = new URLSearchParams(window.location.search);
  const file   = params.get('file');          // ä¾‹: 01_welcome_home_2010-06-12.md
  const lang   = params.get('lang') || 'jp';  // 'jp' or 'en'

  const listJson = lang === 'en' ? 'en_articles.json' : 'articles.json';
  const baseDir  = lang === 'en' ? 'en_articles'      : 'articles';

  /* ---------------- ãƒ«ãƒ“è¾æ›¸ ---------------- */
  const rubyMap = { 'æœ—':'ã‚ãã‚‰', 'çœ':'ã¾ã“ã¨', 'è‹±ç¾å­':'ãˆã¿ã“' };
  const applyRuby = str =>
    str.replace(/æœ—|çœ|è‹±ç¾å­/g, m => `<ruby>${m}<rt>${rubyMap[m]}</rt></ruby>`);

  /* ---------------- ãƒ­ãƒ¼ãƒæ•°å­— ---------------- */
  const toRoman = n => ['','â… ','â…¡','â…¢','â…£','â…¤','â…¥','â…¦','â…§','â…¨','â…©',
                          'â…ª','â…«','â…©â…¢','â…©â…£','â…©â…¤','â…©â…¥','â…©â…¦','â…©â…§','â…©â…¨','â…©â…©'][n] || n;

  /* ======================================================
        ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼  (å³æ™‚ async IIFE ã§é †åºã‚’ä¿è¨¼)
     ====================================================== */
  (async () => {
    /* ---------- â‘  è¨˜äº‹ãƒªã‚¹ãƒˆ JSON ã‚’èª­ã‚€ ---------- */
    let fileMap;
    try {
      fileMap = await fetch(listJson).then(r => r.json());
    } catch (e) {
      console.error('âŒ è¨˜äº‹ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      document.getElementById('article-content').textContent =
        'è¨˜äº‹ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      return;
    }

    /* ---------- â‘¡ ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒŠãƒ“ç”Ÿæˆ ---------- */
    buildGlobalNav(fileMap);

    /* ---------- â‘¢ è¨˜äº‹æŒ‡å®šãŒãªã„å ´åˆ ---------- */
    if (!file) {
      document.getElementById('article-content').innerHTML =
        '<p>âš  è¨˜äº‹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
      return;
    }

    /* ---------- â‘£ meta ã‚’å–å¾— ---------- */
    const meta = fileMap.find(e => e.filename === file);
    if (!meta) {
      document.getElementById('article-content').innerHTML =
        '<p>âš  æŒ‡å®šã•ã‚ŒãŸè¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    /* ---------- â‘¤ è¦‹å‡ºã— & ãƒ¡ã‚¿æƒ…å ± ---------- */
    setArticleHeader(meta);

    /* ---------- â‘¥ Markdown æœ¬æ–‡ ---------- */
    try {
      const md = await fetch(`${baseDir}/${file}`).then(r => r.text());
      document.getElementById('article-content').innerHTML = marked.parse(md);
    } catch (e) {
      console.error('âŒ Markdown ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      document.getElementById('article-content').textContent =
        'æœ¬æ–‡ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    }

    /* ---------- â‘¦ å‰å¾ŒãƒŠãƒ“ ---------- */
    setPrevNext(fileMap, meta);

    /* ---------- â‘§ ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ¼”å‡º ---------- */
    runAkiraLogEffects();          // æ—¢å­˜ã®æ¼”å‡ºé–¢æ•°ï¼ˆãã®ã¾ã¾åˆ©ç”¨ï¼‰
    initScrollTopButton();         // ä¸‹ã§å®šç¾©
  })();

  /* ======================================================
        ä»¥ä¸‹ â”€ ä¾¿åˆ©é–¢æ•°ãŸã¡
     ====================================================== */
  /* -- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒŠãƒ“ -- */
fetch('articles.json')
  .then(res => res.json())
  .then(data => {
    const navList = document.getElementById('digest-nav');
    navList.innerHTML = `
      <li><a href="index.html">ğŸ“˜ ç›®æ¬¡ï¼ˆIndexï¼‰ã«æˆ»ã‚‹</a></li>
    `;
    navList.innerHTML += data.map(entry => {
      const lang = (window.location.search.includes('lang=en')) ? 'en' : 'jp';
      const title = lang === 'en' ? entry.title_en : entry.title_jp;
      const label = lang === 'en'
        ? `Chapter ${entry.chapter}: ${title}`
        : `ç¬¬${entry.chapter}ç«  ${title}`;
      if (entry.draft === true) {
        // ã‚°ãƒ¬ãƒ¼è¡¨ç¤ºã€ãƒªãƒ³ã‚¯ç„¡ã—
        return `<li><span style="color:gray;">${label}${lang === 'en' ? ' (Coming Soon)' : 'ï¼ˆç·¨é›†ä¸­ï¼‰'}</span></li>`;
      }
      // å…¬é–‹æ¸ˆã¿ã®ã¿ãƒªãƒ³ã‚¯
      return `<li><a href="article.html?file=${entry.filename}&lang=${lang}">${label}</a></li>`;
    }).join('');
  });

  /* -- ã‚¿ã‚¤ãƒˆãƒ« & æ—¥ä»˜å ´æ‰€ -- */
  function setArticleHeader(meta) {
    /* è¦‹å‡ºã— */
    const h3 = document.getElementById('article-title');
    if (lang === 'en') {
      h3.textContent = `Chapter ${meta.chapter}: ${meta.title_en}`;
    } else {
      h3.innerHTML = applyRuby(`${toRoman(meta.chapter)}. ${meta.title_jp}`);
    }

    /* ãƒ¡ã‚¿æƒ…å ±ï¼ˆæ—¥ä»˜ & å ´æ‰€ï¼‰ */
    const h4 = document.getElementById('article-meta');
    let metaHtml = '';

    if (lang === 'en') {
      if (meta.timestamp) {
        const dt = new Date(meta.timestamp);
        const opts = { year:'numeric', month:'long', day:'numeric',
                       hour:'numeric', minute:'2-digit', hour12:true };
        const la = new Intl.DateTimeFormat('en-US',{...opts,timeZone:'America/Los_Angeles'}).format(dt);
        const jp = new Intl.DateTimeFormat('en-US',{...opts,timeZone:'Asia/Tokyo'}).format(dt);
        metaHtml = `${la} â€” LA / ${jp} JST`;
      } else {
        metaHtml = `${meta.date} â€” ${meta.location_en}`;
      }
    } else {
      if (meta.timestamp) {
        const dt = new Date(meta.timestamp);
        const opts = { year:'numeric', month:'numeric', day:'numeric',
                       hour:'numeric', minute:'2-digit', hour12:true };
        const la = new Intl.DateTimeFormat('ja-JP',{...opts,timeZone:'America/Los_Angeles'}).format(dt);
        const jp = new Intl.DateTimeFormat('ja-JP',{...opts,timeZone:'Asia/Tokyo'}).format(dt);
        metaHtml = `${la} ${applyRuby(meta.location_jp)} / ${jp} æ—¥æœ¬æ™‚é–“`;
      } else {
        const [Y,M,D] = meta.date.split('-');
        metaHtml = `${Y}å¹´${+M}æœˆ${+D}æ—¥ãƒ»${applyRuby(meta.location_jp)}`;
      }
    }
    h4.innerHTML = metaHtml;
  }

  /* -- å‰å¾ŒãƒŠãƒ“ -- */
  function setPrevNext(list, meta) {
    const idx = list.findIndex(e => e.filename === meta.filename);

    /* å‰ã¸ */
    const prevA = document.getElementById('prev-link');
    if (idx > 0) applyNav(prevA, list[idx-1], 'prev');

    /* æ¬¡ã¸ */
    const nextA = document.getElementById('next-link');
    if (idx < list.length-1) applyNav(nextA, list[idx+1], 'next');
  }
  function applyNav(a, item, which) {
    if (item.draft) {
      a.href = '#';
      a.innerHTML = lang==='en'
        ? (which==='prev'
            ? `â—€ Chapter ${item.chapter}: ${item.title_en} (Coming Soon)`
            : `Chapter ${item.chapter}: ${item.title_en} â–¶ (Coming Soon)`)
        : (which==='prev'
            ? `â—€ ç¬¬${item.chapter}ç«  ${item.title_jp}ï¼ˆç·¨é›†ä¸­ï¼‰`
            : `ç¬¬${item.chapter}ç«  ${item.title_jp} â–¶ï¼ˆç·¨é›†ä¸­ï¼‰`);
      a.style.pointerEvents = 'none';
      a.style.color = 'gray';
    } else {
      a.href = `article.html?file=${item.filename}&lang=${lang}`;
      a.textContent = lang==='en'
        ? (which==='prev'
            ? `â—€ Chapter ${item.chapter}: ${item.title_en}`
            : `Chapter ${item.chapter}: ${item.title_en} â–¶`)
        : (which==='prev'
            ? `â—€ ç¬¬${item.chapter}ç«  ${item.title_jp}`
            : `ç¬¬${item.chapter}ç«  ${item.title_jp} â–¶`);
    }
  }

  /* -- ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -- */
  function initScrollTopButton() {
    const topBtn = document.getElementById('topbutton');
    window.addEventListener('scroll', () => {
      topBtn.style.display = window.scrollY > 200 ? 'block' : 'none';
    });
    window.scrollTo({ top: 0 });      // è¨˜äº‹åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å…ˆé ­ã¸
  }
</script>



  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆé¡ -->
  <script src="../js/load_articles.js"></script>
  <script src="../js/scripts.js"></script>
  <script src="../js/uikit.js"></script>
  <script src="../js/uikit-icons.min.js"></script>
  <script src="https://kit.fontawesome.com/e499977db9.js" crossorigin="anonymous"></script>

</body>

</html>